<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ponto - RH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .success-animation {
            animation: successPulse 0.6s ease-out;
        }
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .botao-ponto {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        .botao-ponto:hover {
            transform: scale(1.05);
        }
        .botao-ponto:active {
            transform: scale(0.95);
        }
        .botao-verde {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .botao-vermelho {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2L3 7v11a2 2 0 002 2h10a2 2 0 002-2V7l-7-5z"/>
                        </svg>
                    </div>
                    <h1 class="text-xl font-semibold text-gray-900">AM Gráfica</h1>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600 hidden sm:block">
                        Sistema de Controle de Ponto
                    </div>
                    <button onclick="window.location.href = '{% url "main:historico" %}'"
                            class="flex items-center space-x-1 px-3 py-2 text-sm font-medium text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Histórico</span>
                    </button>
                    <button id="logoutButton"
                            class="flex items-center space-x-1 px-3 py-2 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Sair</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tela de Bater Ponto -->
        <div id="pontoScreen" class="fade-in">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <!-- Cabeçalho -->
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-900">Registro de Ponto</h2>
                        <p class="text-gray-600 mt-2">Clique no botão para registrar entrada ou saída</p>
                    </div>

                    <!-- Data e Hora -->
                    <div class="text-center mb-8">
                        <div class="inline-flex flex-col items-center bg-gray-50 rounded-lg px-6 py-4">
                            <span class="text-2xl font-bold text-gray-900" id="currentDate">--/--/----</span>
                            <span class="text-4xl font-bold text-indigo-600 mt-2" id="currentTime">--:--:--</span>
                        </div>
                    </div>

                    <!-- Funcionário -->
                    <div class="text-center mb-8">
                        <p class="text-sm text-gray-600 mb-2">Funcionário</p>
                        <div id="nomeFuncionarioCampo"
                             class="inline-block px-6 py-3 border border-gray-300 rounded-lg text-gray-800 bg-gray-100 font-semibold text-lg">
                            Carregando Nome...
                        </div>
                        <input type="hidden" id="funcionarioId" name="funcionarioId" required>
                    </div>

                    <!-- Último Registro -->
                    <div id="ultimoRegistroInfo" class="hidden text-center mb-6 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-800">
                            <span class="font-semibold">Último ponto:</span>
                            <span id="ultimoRegistroTexto">-</span>
                        </p>
                    </div>

                    <!-- BOTÃO CENTRALIZADO GRANDE -->
                    <div class="flex justify-center items-center my-8">
                        <button id="botaoPonto"
                                class="botao-ponto w-72 h-72 rounded-full text-white font-bold text-2xl flex flex-col items-center justify-center transition-all duration-300 pulse-animation">
                            <span id="textoBotao">CARREGANDO</span>
                            <span id="subtituloBotao" class="text-lg font-normal mt-4 opacity-90">Clique para registrar</span>
                        </button>
                    </div>

                    <!-- Dica -->
                    <div class="text-center mt-6">
                        <p class="text-sm text-gray-500" id="dicaBotao">
                            O sistema detecta automaticamente se é entrada ou saída
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensagem de Sucesso -->
        <div id="successMessage" class="hidden fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            <div class="flex items-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span id="successText">Operação realizada com sucesso!</span>
            </div>
        </div>
    </main>

    <script>
        const PONTO_API_URL = '/api/registro-ponto/';
        const ULTIMO_PONTO_API_URL = '/api/ultimo-ponto/';
        const LOGOUT_API_URL = '/api/logout/';

        let usuarioLogado = null;
        let proximoTipo = 'E';

        // Elementos DOM
        const botaoPonto = document.getElementById('botaoPonto');
        const textoBotao = document.getElementById('textoBotao');
        const subtituloBotao = document.getElementById('subtituloBotao');
        const dicaBotao = document.getElementById('dicaBotao');
        const nomeFuncionarioCampo = document.getElementById('nomeFuncionarioCampo');
        const ultimoRegistroInfo = document.getElementById('ultimoRegistroInfo');
        const ultimoRegistroTexto = document.getElementById('ultimoRegistroTexto');

        // ----------------------------------------------------------------------
        // 1. Funções de Mensagens
        // ----------------------------------------------------------------------

        function showSuccess(message) {
            const successMessage = document.getElementById('successMessage');
            const successText = document.getElementById('successText');

            successText.textContent = message;
            successMessage.classList.remove('hidden');
            successMessage.classList.add('success-animation');

            setTimeout(() => {
                successMessage.classList.add('hidden');
                successMessage.classList.remove('success-animation');
            }, 3000);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(errorDiv);

            setTimeout(() => {
                document.body.removeChild(errorDiv);
            }, 3000);
        }

        // ----------------------------------------------------------------------
        // 2. Relógio em tempo real
        // ----------------------------------------------------------------------

        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR');
            const dateString = now.toLocaleDateString('pt-BR');

            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('currentDate').textContent = dateString;
        }

        setInterval(updateClock, 1000);
        updateClock();

        // ----------------------------------------------------------------------
        // 3. Lógica do Botão de Ponto Único
        // ----------------------------------------------------------------------

        // Buscar último ponto do funcionário
        async function buscarUltimoPonto() {
            if (!usuarioLogado) return;

            try {
                const response = await fetch(`${ULTIMO_PONTO_API_URL}?funcionario_id=${usuarioLogado.id}`);

                if (!response.ok) {
                    throw new Error('Erro ao buscar último ponto');
                }

                const data = await response.json();

                // Atualizar estado do botão
                proximoTipo = data.proximo_tipo;
                atualizarBotaoPonto();

                // Mostrar último registro se existir
                if (data.ultimo_timestamp) {
                    ultimoRegistroTexto.textContent = `${data.ultimo_tipo === 'E' ? 'Entrada' : 'Saída'} às ${data.ultimo_timestamp.split(' ')[1]}`;
                    ultimoRegistroInfo.classList.remove('hidden');
                } else {
                    ultimoRegistroInfo.classList.add('hidden');
                }

            } catch (error) {
                console.error('Erro ao buscar último ponto:', error);
            }
        }

        // Atualizar aparência do botão
        function atualizarBotaoPonto() {
            if (proximoTipo === 'E') {
                // Verde - Entrada
                botaoPonto.className = 'botao-ponto w-72 h-72 rounded-full text-white font-bold text-2xl flex flex-col items-center justify-center transition-all duration-300 pulse-animation botao-verde';
                textoBotao.textContent = 'ENTRADA';
                subtituloBotao.textContent = 'Clique para iniciar o trabalho';
                dicaBotao.textContent = 'Próximo: início do expediente';
            } else {
                // Vermelho - Saída
                botaoPonto.className = 'botao-ponto w-72 h-72 rounded-full text-white font-bold text-2xl flex flex-col items-center justify-center transition-all duration-300 pulse-animation botao-vermelho';
                textoBotao.textContent = 'SAÍDA';
                subtituloBotao.textContent = 'Clique para encerrar';
                dicaBotao.textContent = 'Próximo: fim do expediente';
            }
        }

        // Registrar ponto
        async function registrarPonto() {
            if (!usuarioLogado) {
                showError('Usuário não identificado');
                return;
            }

            try {
                // Desabilitar botão temporariamente
                botaoPonto.disabled = true;
                botaoPonto.style.opacity = '0.7';

                const response = await fetch(PONTO_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        funcionario_id: usuarioLogado.id,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Erro ao registrar ponto');
                }

                const data = await response.json();

                // Atualizar próximo tipo
                proximoTipo = data.proximo_tipo;
                atualizarBotaoPonto();

                // Mostrar feedback
                showSuccess(`${data.tipo_registrado === 'E' ? 'Entrada' : 'Saída'} registrada às ${data.timestamp_formatado}`);

                // Atualizar último registro
                setTimeout(buscarUltimoPonto, 1000);

            } catch (error) {
                console.error('Erro ao registrar ponto:', error);
                showError(error.message);
            } finally {
                // Reabilitar botão
                setTimeout(() => {
                    botaoPonto.disabled = false;
                    botaoPonto.style.opacity = '1';
                }, 1000);
            }
        }

        // ----------------------------------------------------------------------
        // 4. Lógica de Logout e Timeout por Inatividade
        // ----------------------------------------------------------------------

        const INACTIVITY_TIMEOUT_MS = 2 * 60 * 1000; // 2 minutos
        let timeout;

        async function doLogout(reason = 'Você foi desconectado manualmente.') {
            // 1. Limpa o timer
            clearTimeout(timeout);

            // 2. Chama a API do Django para encerrar a sessão
            try {
                await fetch(LOGOUT_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
            } catch (error) {
                console.error('Erro ao encerrar sessão no Django:', error);
            }

            // 3. Limpa os dados de usuário do localStorage
            localStorage.removeItem('usuarioLogado');

            // 4. Exibe a mensagem e redireciona
            showError(reason);

            setTimeout(() => {
                window.location.href = "{% url 'main:inicio' %}";
            }, 1500);
        }

        function resetInactivityTimer() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                doLogout('Sessão expirada por inatividade (2 minutos).');
            }, INACTIVITY_TIMEOUT_MS);
        }

        // ----------------------------------------------------------------------
        // 5. Inicialização do Sistema
        // ----------------------------------------------------------------------

        function inicializarSistema() {
            // Verificar se usuário está logado
            const usuarioSalvo = localStorage.getItem('usuarioLogado');
            if (!usuarioSalvo) {
                window.location.href = '/';
                return;
            }

            usuarioLogado = JSON.parse(usuarioSalvo);

            // Atualizar interface com dados do usuário
            if (nomeFuncionarioCampo) {
                nomeFuncionarioCampo.textContent = usuarioLogado.nome;
            }

            // Buscar último ponto
            buscarUltimoPonto();

            // Configurar evento do botão
            botaoPonto.addEventListener('click', registrarPonto);

            // Configurar listeners de inatividade
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('keypress', resetInactivityTimer);
            resetInactivityTimer();

            // Configurar botão de logout
            const logoutBtn = document.getElementById('logoutButton');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    doLogout('Você foi desconectado manualmente.');
                });
            }
        }

        // Iniciar quando o DOM carregar
        document.addEventListener('DOMContentLoaded', inicializarSistema);
    </script>
</body>
</html>